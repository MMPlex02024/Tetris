#include "igra.h"
#include <random>
#include <raylib.h>

Igra::Igra()
{
	ploca = Ploca();
	blokovi = GetAllBlokovi();
	trenutniBlok = GetRandomBlok();
	sljedeciBlok = GetRandomBlok();

}

Blok Igra::GetRandomBlok()
{
	if(blokovi.empty()) {
		blokovi = GetAllBlokovi();
	} 

	int randomIndex = rand() % blokovi.size();
	Blok blok = blokovi[randomIndex];
	blokovi.erase(blokovi.begin() + randomIndex);
	
	return blok;
}

std::vector<Blok> Igra::GetAllBlokovi() const
{
	return { IBlok(), JBlok(), OBlok(), SBlok(), TBlok(), ZBlok(), LBlok() };

}

void Igra:: Draw() {
	ploca.Mreza();
	trenutniBlok.Draw();
}

void Igra::MoveBlockLeft()
{
    trenutniBlok.Move(0, -1);
    if (CelijaVani()) {
        trenutniBlok.Move(0, 1);
    }
}

void Igra::MoveBlockRight()
{
    trenutniBlok.Move(0, 1);
    if (CelijaVani()) {
        trenutniBlok.Move(0, -1);
    }
}

void Igra::MoveBlockDown()
{
    trenutniBlok.Move(1, 0);
    if (CelijaVani()) {
        trenutniBlok.Move(-1, 0);
    }
}

int Igra::CurrentBlockRow() const
{
    return trenutniBlok.kretanjeRed;
}

void Igra::HandleInput()
{
    int keyPressed = GetKeyPressed();
    switch (keyPressed)
    {
        case KEY_LEFT:
            MoveBlockLeft();
            break;
        case KEY_RIGHT:
            MoveBlockRight();
            break;
        case KEY_DOWN:
            MoveBlockDown();
            break;
        case KEY_UP:
            RotacijaBloka();
            break;
        default:
            break;
    }
}

void Igra::RotateBlock()
{
    trenutniBlok.Rotiraj();
    if (CelijaVani()) {
        trenutniBlok.VratiRotaciju();
    }
}

bool Igra::celijavani()
{
    std::vector<Pozicija> tiles = trenutniBlok.GetAbsoluteCells();
    for (const Pozicija &item : tiles) {
        if (ploca.celijavani(item.red, item.stupac)) {
            return true;
        }
    }
    return false;
}
